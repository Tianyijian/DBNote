# 21. 数据库查询优化技术
重点与难点

- 理解查询优化的整体思路是什么？
- 理解并掌握基于关系代数进行逻辑查询优化的方法和原则
- 理解物理查询优化中的代价估算方法

## 21.1 为什么要及什么是查询优化?
- 语义优化：利用模型的语义及完整性规则，优化查询。
- 语法优化 ---逻辑层优化：利用语法结构，优化操作执行顺序；
- 执行优化 ---物理层优化：存取路径和执行算法的选择与执行次序优化

## 21.2 查询优化的基本思路
- 语义优化是内容等价性
- 逻辑查询优化是关系代数操作次序的优化
- 物理查询优化是关系代数操作实现算法选择的优化


## 21.3 逻辑查询优化
- 逻辑优化策略：
	- **尽可能地早做选择和投影**：可使中间结果变小，节省几个数量级的执行时间。
	- **把选择与投影串接起来**：一元运算序列可一起执行，只需对整个关系扫描一遍。
	- 把投影与其前或后的二元运算结合起来：在第一次用关系时去掉一些无关属性，可以避免多次扫描整个关系。
	- **把某些选择与其前的笛卡尔积合并成一个连接**：当R×S前有选择运算且其中有条件是R、S属性间比较的运算时，可将其转化为连接运算可节省时间。
	- 执行连接运算前对关系做适当预处理：文件排序、建立临时索引等，可使两关系公共值高效联接。
	- 找出表达式里的公共子表达式：若公共子表达式结果不大，则预先计算，以后可读入此结果，节时多，尤当视图情况下有用。
- **先差运算再投影和先投影再差运算结果可能不一样**
- 乘积操作和其后的条件应组成连接操作

## 21.4 物理查询优化
- 总体思路
	1. 获取数据库的相关信息 (定期统计)；
	2. 选取相应的执行层例行程序；
	3. 依据相关信息进行代价估算,并选择代价最少的例行程序及确定相应的参数；
	4. 形成查询计划：以基本的例行程序为基本，确定这些例行程序的执行顺序
- **代价估算**
	- 估算投影：根据元组投影前后大小计算占据块数B
	- 估算选择 =： T(S) = T(R) / V(R,A)，不知道V(R,A)时，估计：T(S) = T(R)/10
	- 估算选择 < 或 > ：T(S) = T(R)/3 
	- 估算选择 and： A=10 AND B<20 -->> T(S) = T(R)/(V(R, A)*3)
	- 估算选择 or： T(S)=n(1-(1-m 1 /n)(1-m 2 /n))
	- 估算连接：T (S)=T(R)T(S)/max(V(R,Y),V(S,Y))

## 21.5 习题
- 当发现数据库系统运行性能下降时，可能的原因是：
	- 关于该数据库的统计信息过时了，造成物理实现算法选择决策上的错误。
	- 数据库的物理存储结构被破坏了，致使原有存储结构的特性丢失。
	- 数据库的物理存储中产生了大量的垃圾，影响了查询实现算法的性能。